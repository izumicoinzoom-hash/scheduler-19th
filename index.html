<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第19期青年部 時間帯詳細調整 (G-Cal連携)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        window.gapiReady = false;
        window.gisReady = false;

        window.onGapiLoad = () => {
            window.gapiReady = true;
            if (window.initGapi) window.initGapi();
        };
        window.onGisLoad = () => {
            window.gisReady = true;
            if (window.initGis) window.initGis();
        };
    </script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="onGisLoad()"></script>
    <script src="https://apis.google.com/js/api.js" async defer onload="onGapiLoad()"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
        .time-segment { transition: all 0.1s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .gcal-connected { border-color: #10b981; background-color: #f0fdf4; color: #059669 !important; }
        .gcal-waiting { opacity: 0.6; pointer-events: none; }
        
        /* 予定ありのマス（ストライプ背景） */
        .is-busy-slot {
            background-color: #fee2e2;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(239, 68, 68, 0.1) 5px, rgba(239, 68, 68, 0.1) 10px);
            cursor: not-allowed !important;
        }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-900 min-h-screen pb-20">

    <div id="app" class="max-w-md mx-auto">
        <!-- Header -->
        <header class="sticky top-0 z-30 bg-[#F8FAFC]/80 backdrop-blur-md border-b border-slate-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-100">
                        <i data-lucide="clock" class="text-white w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="text-sm font-black text-slate-900 leading-none">第19期 青年部</h1>
                        <p class="text-[9px] font-bold text-indigo-500 uppercase tracking-[0.2em] mt-1">G-Cal Integrated</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="gcal-auth-btn" onclick="handleAuthClick()" class="gcal-waiting p-2 bg-white border border-slate-200 rounded-xl shadow-sm hover:bg-slate-50 transition-all active:scale-95 flex items-center gap-2" title="Googleカレンダーと同期">
                        <img src="https://www.gstatic.com/images/branding/product/1x/calendar_2020q4_48dp.png" class="w-5 h-5" alt="Google Calendar">
                        <span id="gcal-btn-text" class="text-[10px] font-bold text-slate-400">読込中</span>
                    </button>
                    <div id="userBadge" class="hidden px-3 py-1 bg-white border border-slate-200 rounded-full text-[10px] font-bold text-slate-500 shadow-sm">
                        <span id="activeUserName"></span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Loading Screen -->
        <div id="loading" class="flex flex-col items-center justify-center py-40 px-10 text-center">
            <div id="loading-spinner" class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p id="loading-text" class="text-sm font-bold text-slate-400">データベース同期中...</p>
        </div>

        <!-- Main Content -->
        <main id="mainContent" class="hidden px-4 pt-6 space-y-6">
            <!-- Navigation -->
            <div class="flex bg-slate-200/50 p-1 rounded-2xl overflow-x-auto no-scrollbar">
                <button onclick="switchTab('config')" id="tab-config" class="flex-none px-4 py-3 text-[10px] font-black rounded-xl transition-all text-slate-500 whitespace-nowrap">候補日の設定</button>
                <button onclick="switchTab('input')" id="tab-input" class="flex-1 py-3 text-[10px] font-black rounded-xl transition-all bg-white shadow-sm text-indigo-600 whitespace-nowrap">自分の回答</button>
                <button onclick="switchTab('result')" id="tab-result" class="flex-1 py-3 text-[10px] font-black rounded-xl transition-all text-slate-500 whitespace-nowrap">全員の重なり</button>
            </div>

            <!-- VIEW: CONFIG -->
            <section id="view-config" class="hidden space-y-6">
                <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-2xl">
                    <h3 class="text-xs font-black text-indigo-600 uppercase mb-2">主催者ガイド</h3>
                    <p class="text-[10px] text-indigo-500 leading-relaxed font-bold">
                        1. カレンダーから候補日をタップして選択します。<br>
                        2. 下の「候補日を確定する」ボタンを押します。<br>
                        3. 「自分の回答」タブで時間が選べるようになります。
                    </p>
                </div>
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-black text-slate-800 text-sm">カレンダーから候補を選択</h2>
                        <span id="selectedCountLabel" class="text-[10px] font-bold px-2 py-1 bg-indigo-50 text-indigo-600 rounded-lg">0件選択中</span>
                    </div>
                    <div id="calendarContainer" class="space-y-6"></div>
                    <div class="mt-8 space-y-3">
                        <button onclick="saveConfig()" id="configSaveBtn" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-black text-lg shadow-xl shadow-slate-200 active:scale-95 transition-transform flex items-center justify-center gap-3">
                            <span>候補日を確定する</span>
                            <i data-lucide="calendar-check" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- VIEW: INPUT -->
            <section id="view-input" class="space-y-6">
                <div id="no-dates-msg" class="hidden py-20 text-center bg-white rounded-3xl border-2 border-dashed border-slate-100 px-10">
                    <div class="w-16 h-16 bg-slate-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-slate-200">
                        <i data-lucide="calendar-range" class="w-8 h-8"></i>
                    </div>
                    <p class="text-sm font-black text-slate-400 leading-relaxed">候補日がまだありません</p>
                    <p class="text-[10px] font-bold text-slate-300 mt-2">「候補日の設定」タブから日付を<br>選んで確定してください。</p>
                </div>
                <div id="input-container" class="space-y-6">
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Your Name</label>
                        <input type="text" id="userName" placeholder="お名前を入力" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-4 font-bold text-lg outline-none focus:border-indigo-500 transition-all">
                        <div id="gcal-status" class="mt-3 text-[10px] font-bold text-slate-400 flex items-center gap-1 min-h-[1rem]">
                        </div>
                    </div>
                    <div id="inputGrid" class="space-y-3"></div>
                    <button onclick="saveData()" id="saveBtn" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black text-lg shadow-xl shadow-indigo-200 active:scale-95 transition-transform flex items-center justify-center gap-3">
                        <span>保存する</span><i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
            </section>

            <!-- VIEW: RESULT -->
            <section id="view-result" class="hidden space-y-6">
                <div class="bg-indigo-600 rounded-[2rem] p-6 text-white shadow-xl shadow-indigo-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] font-bold opacity-70 uppercase tracking-widest">Total Respondents</p>
                            <h2 class="text-3xl font-black"><span id="respondentCount">0</span> <span class="text-sm font-medium">名</span></h2>
                        </div>
                        <button onclick="confirmReset()" class="p-2 bg-white/10 hover:bg-white/20 rounded-xl transition-colors text-white/70 hover:text-white">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="mt-4 pt-4 border-t border-white/10 flex -space-x-2" id="facePile"></div>
                </div>
                <div id="resultGrid" class="space-y-6"></div>
            </section>
        </main>

        <!-- Modal -->
        <div id="confirmModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm hidden">
            <div class="bg-white rounded-[2.5rem] w-full max-w-xs p-8 shadow-2xl">
                <div class="w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-center font-black text-slate-900 text-xl mb-2">回答をすべて削除</h3>
                <p class="text-center text-slate-500 text-xs leading-relaxed mb-8">
                    現在集まっている回答データが消去されます。
                </p>
                <div class="space-y-3">
                    <button onclick="resetAllData()" id="resetSubmitBtn" class="w-full bg-red-500 text-white py-4 rounded-2xl font-black">実行する</button>
                    <button onclick="closeModal()" class="w-full bg-slate-100 text-slate-600 py-4 rounded-2xl font-black">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBQMwDV9sP_z6M6SSiK9-fQew2Ct20GIko",
            authDomain: "time-slot-planner.firebaseapp.com",
            projectId: "time-slot-planner",
            storageBucket: "time-slot-planner.firebasestorage.app",
            messagingSenderId: "971422980882",
            appId: "1:971422980882:web:d5c2e2868792f6b333b1cb"
        };

        const GOOGLE_CLIENT_ID = "504793204916-q1ujuooi5nengqsoi96qt7ojnah44kl0.apps.googleusercontent.com"; 
        const GOOGLE_API_KEY = "AIzaSyBMkfMCvrtvTlgZsqrziRgl071N1igOykw";
        const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
        const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : YOUR_FIREBASE_CONFIG;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'scheduler-19th-prod';

        let targetDates = [];
        let tempSelectedDates = []; 
        let allResponses = [];
        let currentUser = null;
        let gcalEvents = []; 
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let unsubConfig = null;
        let unsubResponses = null;

        const START_HOUR = 10;
        const END_HOUR = 22;
        const HOURS = Array.from({length: END_HOUR - START_HOUR + 1}, (_, i) => START_HOUR + i);

        // --- Google API Logic ---
        window.initGapi = async () => {
            if (typeof gapi === 'undefined') return;
            try {
                await gapi.load('client', async () => {
                    await gapi.client.init({
                        apiKey: GOOGLE_API_KEY,
                        discoveryDocs: [DISCOVERY_DOC],
                    });
                    gapiInited = true;
                    checkGoogleReady();
                });
            } catch (e) { console.error("GAPI Init fail", e); }
        };

        window.initGis = () => {
            if (typeof google === 'undefined') return;
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                    callback: async (resp) => {
                        if (resp.error !== undefined) throw (resp);
                        await listUpcomingEvents();
                        updateUI();
                    },
                });
                gisInited = true;
                checkGoogleReady();
            } catch (e) { console.error("GIS Init fail", e); }
        };

        function checkGoogleReady() {
            if (gapiInited && gisInited) {
                const btn = document.getElementById('gcal-auth-btn');
                const btnText = document.getElementById('gcal-btn-text');
                if (btn) {
                    btn.classList.remove('gcal-waiting');
                    btnText.innerText = "連携";
                    btnText.classList.replace('text-slate-400', 'text-slate-600');
                }
            }
        }

        window.handleAuthClick = () => {
            if (!gapiInited || !gisInited) {
                alert("Google APIを準備中です。数秒後にもう一度押してください。");
                return;
            }
            tokenClient.requestAccessToken({prompt: 'consent'});
        };

        async function listUpcomingEvents() {
            try {
                const response = await gapi.client.calendar.events.list({
                    calendarId: 'primary',
                    timeMin: (new Date()).toISOString(),
                    showDeleted: false,
                    singleEvents: true,
                    maxResults: 250,
                    orderBy: 'startTime',
                });
                gcalEvents = response.result.items;
                const statusEl = document.getElementById('gcal-status');
                if (statusEl) {
                    statusEl.innerHTML = `<i data-lucide="check-circle-2" class="text-emerald-500 w-3 h-3"></i> Googleカレンダー同期完了`;
                    lucide.createIcons();
                }
                const btn = document.getElementById('gcal-auth-btn');
                if (btn) {
                    btn.classList.add('gcal-connected');
                    document.getElementById('gcal-btn-text').innerText = "同期中";
                }
            } catch (err) { console.error("GCal fetch error:", err); }
        }

        // --- Firebase Handlers ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) { console.error("Auth init failed:", err); }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) startSync();
            else {
                if (unsubConfig) unsubConfig();
                if (unsubResponses) unsubResponses();
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('loading').classList.remove('hidden');
            }
        });

        function startSync() {
            if (!currentUser) return;

            const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'dates');
            if (unsubConfig) unsubConfig();
            unsubConfig = onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    targetDates = docSnap.data().list || [];
                    tempSelectedDates = [...targetDates];
                }
                updateUI();
            });

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'responses'));
            if (unsubResponses) unsubResponses();
            unsubResponses = onSnapshot(q, (snapshot) => {
                allResponses = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateUI();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
            });
        }

        function updateUI() {
            renderInputGrid();
            renderResultGrid();
            renderCalendar();
            
            const hasDates = targetDates.length > 0;
            const noDatesEl = document.getElementById('no-dates-msg');
            const inputContEl = document.getElementById('input-container');
            if (noDatesEl) noDatesEl.classList.toggle('hidden', hasDates);
            if (inputContEl) inputContEl.classList.toggle('hidden', !hasDates);

            const myData = allResponses.find(r => r.id === currentUser?.uid);
            if (myData && !document.getElementById('userName').value) {
                const nameInp = document.getElementById('userName');
                if (nameInp) nameInp.value = myData.name || "";
                const badgeEl = document.getElementById('userBadge');
                if (badgeEl) badgeEl.classList.remove('hidden');
                const activeNameEl = document.getElementById('activeUserName');
                if (activeNameEl) activeNameEl.innerText = myData.name;
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendarContainer');
            if (!container) return;
            container.innerHTML = '';
            const now = new Date();
            for(let i=0; i<2; i++) {
                const monthDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const grid = document.createElement('div');
                grid.className = 'space-y-2';
                grid.innerHTML = `<h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">${monthDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' })}</h3>`;
                
                const daysGrid = document.createElement('div');
                daysGrid.className = 'calendar-grid';
                ['日','月','火','水','木','金','土'].forEach(d => daysGrid.innerHTML += `<div class="text-[10px] font-bold text-center text-slate-300 py-1">${d}</div>`);
                for(let p=0; p<monthDate.getDay(); p++) daysGrid.innerHTML += `<div></div>`;

                const lastDay = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
                for(let d=1; d<=lastDay; d++) {
                    const current = new Date(monthDate.getFullYear(), monthDate.getMonth(), d);
                    const dateStr = `${current.getMonth()+1}/${current.getDate()}(${['日','月','火','水','木','金','土'][current.getDay()]})`;
                    const isSelected = tempSelectedDates.includes(dateStr);
                    const dayEl = document.createElement('button');
                    dayEl.className = `h-10 text-xs font-black rounded-lg transition-all ${isSelected ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`;
                    dayEl.innerText = d;
                    dayEl.onclick = () => {
                        const idx = tempSelectedDates.indexOf(dateStr);
                        if (idx > -1) tempSelectedDates.splice(idx, 1);
                        else tempSelectedDates.push(dateStr);
                        renderCalendar();
                    };
                    daysGrid.appendChild(dayEl);
                }
                grid.appendChild(daysGrid);
                container.appendChild(grid);
            }
            const labelEl = document.getElementById('selectedCountLabel');
            if (labelEl) labelEl.innerText = `${tempSelectedDates.length}件選択中`;
        }

        function renderInputGrid() {
            const container = document.getElementById('inputGrid');
            if (!container) return;
            container.innerHTML = '';
            const myData = allResponses.find(r => r.id === currentUser?.uid);
            const myAvailability = myData?.availability || {};
            targetDates.forEach(date => {
                const dateData = myAvailability[date] || [];
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl p-4 border border-slate-100 shadow-sm';
                const busyHours = [];
                
                gcalEvents.forEach(evt => {
                    const start = new Date(evt.start.dateTime || evt.start.date);
                    const end = new Date(evt.end.dateTime || evt.end.date);
                    const evtDate = `${start.getMonth()+1}/${start.getDate()}(${['日','月','火','水','木','金','土'][start.getDay()]})`;
                    if (evtDate === date) { for(let h=start.getHours(); h<end.getHours(); h++) busyHours.push(h); }
                });

                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-black text-slate-800 text-sm">${date}</span>
                        <button onclick="clearDate('${date}')" class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Clear</button>
                    </div>
                    
                    <!-- 時間の目盛り -->
                    <div class="flex w-full px-0.5 mb-1 gap-0.5">
                        ${HOURS.map(h => `<div class="flex-1 text-center text-[8px] font-black text-slate-300 leading-none">${h}</div>`).join('')}
                    </div>

                    <div class="flex h-10 w-full bg-slate-50 rounded-lg overflow-hidden border border-slate-100 p-1 gap-0.5">
                        ${HOURS.map(h => {
                            const isActive = dateData.includes(h);
                            const isBusy = busyHours.includes(h);
                            
                            const clickAttr = isBusy ? '' : `onclick="toggleTime('${date}', ${h})"`;
                            const busyClass = isBusy ? 'is-busy-slot' : 'hover:bg-slate-100 cursor-pointer';
                            const activeClass = isActive ? 'bg-indigo-600 shadow-sm' : 'bg-white';
                            const tooltip = isBusy ? 'title="Googleカレンダーに予定があります"' : `title="${h}:00"`;
                            
                            return `<div ${clickAttr} ${tooltip}
                                class="flex-1 rounded-sm time-segment ${activeClass} ${busyClass}">
                            </div>`;
                        }).join('')}
                    </div>`;
                container.appendChild(card);
            });
        }

        window.saveConfig = async () => {
            if (!currentUser) return;
            tempSelectedDates.sort((a,b) => {
                const p = s => { const m = s.match(/(\d+)\/(\d+)/); return parseInt(m[1])*100 + parseInt(m[2]); };
                return p(a) - p(b);
            });
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'dates'), { list: tempSelectedDates });
            switchTab('input');
        };

        window.toggleTime = (date, hour) => {
            const myIdx = allResponses.findIndex(r => r.id === currentUser?.uid);
            let myData = myIdx > -1 ? allResponses[myIdx] : { id: currentUser.uid, name: document.getElementById('userName').value, availability: {} };
            if (!myData.availability) myData.availability = {};
            if (!myData.availability[date]) myData.availability[date] = [];
            const idx = myData.availability[date].indexOf(hour);
            if (idx > -1) myData.availability[date].splice(idx, 1);
            else myData.availability[date].push(hour);
            if (myIdx > -1) allResponses[myIdx] = myData; else allResponses.push(myData);
            renderInputGrid();
        };

        window.clearDate = (date) => {
            const myIdx = allResponses.findIndex(r => r.id === currentUser?.uid);
            if (myIdx > -1) { allResponses[myIdx].availability[date] = []; renderInputGrid(); }
        };

        window.saveData = async () => {
            if (!currentUser) return;
            const name = document.getElementById('userName').value.trim();
            if (!name) return alert("お名前を入力してください");
            const myData = allResponses.find(r => r.id === currentUser?.uid);
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'responses', currentUser.uid), {
                name, availability: myData?.availability || {}, updatedAt: new Date().toISOString()
            });
            switchTab('result');
        };

        window.switchTab = (tab) => {
            ['config', 'input', 'result'].forEach(t => {
                const viewEl = document.getElementById(`view-${t}`);
                if (viewEl) viewEl.classList.toggle('hidden', t !== tab);
                const btn = document.getElementById(`tab-${t}`);
                if (btn) btn.className = (t === tab) ? "flex-1 py-3 text-[10px] font-black rounded-xl bg-white shadow-sm text-indigo-600" : "flex-1 py-3 text-[10px] font-black rounded-xl text-slate-500";
            });
            if (tab === 'config') renderCalendar();
        };

        window.renderResultGrid = () => {
            const container = document.getElementById('resultGrid');
            if (!container) return;
            const respondentCount = allResponses.length;
            const countEl = document.getElementById('respondentCount');
            if (countEl) countEl.innerText = respondentCount;
            container.innerHTML = '';
            targetDates.forEach(date => {
                const hourCounts = HOURS.map(h => allResponses.filter(r => r.availability?.[date]?.includes(h)).length);
                container.innerHTML += `
                    <div class="bg-white rounded-3xl p-5 border border-slate-100 shadow-sm">
                        <div class="font-black text-slate-800 mb-2">${date}</div>
                        
                        <!-- 時間の目盛り -->
                        <div class="flex w-full px-1 mb-1 gap-1">
                            ${HOURS.map(h => `<div class="flex-1 text-center text-[8px] font-black text-slate-300 leading-none">${h}</div>`).join('')}
                        </div>

                        <div class="flex h-12 bg-slate-50 rounded-xl p-1 gap-1">
                            ${hourCounts.map((count, i) => {
                                const ratio = respondentCount > 0 ? count / respondentCount : 0;
                                const color = ratio > 0.7 ? 'bg-indigo-600' : ratio > 0.3 ? 'bg-indigo-400' : ratio > 0 ? 'bg-indigo-200' : 'bg-white';
                                return `<div class="flex-1 rounded-md ${color}" title="${HOURS[i]}:00 (${count}名)"></div>`;
                            }).join('')}
                        </div>
                    </div>`;
            });
            const facePile = document.getElementById('facePile');
            if (facePile) {
                facePile.innerHTML = allResponses.slice(0, 8).map(r => `<div class="w-8 h-8 rounded-full bg-white border-2 border-indigo-600 flex items-center justify-center text-[10px] font-black text-indigo-600 shadow-sm">${r.name ? r.name.substring(0, 1) : '?'}</div>`).join('') + (allResponses.length > 8 ? `<div class="w-8 h-8 rounded-full bg-indigo-400 border-2 border-indigo-600 flex items-center justify-center text-[8px] font-black text-white">+${allResponses.length - 8}</div>` : '');
            }
        };

        window.confirmReset = () => document.getElementById('confirmModal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('confirmModal').classList.add('hidden');
        window.resetAllData = async () => {
            if (!currentUser) return;
            const btn = document.getElementById('resetSubmitBtn');
            if (btn) { btn.disabled = true; btn.innerText = "実行中..."; }
            try {
                const snapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'responses'));
                const promises = snapshot.docs.map(d => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'responses', d.id)));
                await Promise.all(promises);
                closeModal();
            } catch (err) { console.error(err); } finally { if (btn) { btn.disabled = false; btn.innerText = "実行する"; } }
        };

        window.addEventListener('load', () => {
            initAuth();
            if (typeof gapi !== 'undefined') window.initGapi();
            if (typeof google !== 'undefined') window.initGis();
            lucide.createIcons();
        });
    </script>
</body>
</html>
